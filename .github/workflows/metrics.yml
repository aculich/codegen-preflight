name: Metrics Collection

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Collect GitHub Metrics
        id: metrics
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Get traffic data (clones and views - last 14 days)
            let clones = { count: 0, uniques: 0 };
            let views = { count: 0, uniques: 0 };
            
            try {
              const { data: clonesData } = await github.rest.repos.getClones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per: 'day',
              });
              clones = {
                count: clonesData.count || 0,
                uniques: clonesData.uniques || 0,
              };
            } catch (error) {
              console.log('Could not fetch clones data:', error.message);
            }

            try {
              const { data: viewsData } = await github.rest.repos.getViews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per: 'day',
              });
              views = {
                count: viewsData.count || 0,
                uniques: viewsData.uniques || 0,
              };
            } catch (error) {
              console.log('Could not fetch views data:', error.message);
            }

            const metrics = {
              timestamp: new Date().toISOString(),
              stars: repo.stargazers_count,
              forks: repo.forks_count,
              watchers: repo.watchers_count,
              open_issues: repo.open_issues_count,
              clones: clones.count,
              clones_uniques: clones.uniques,
              views: views.count,
              views_uniques: views.uniques,
            };

            return metrics;

      - name: Create metrics directory
        run: mkdir -p metrics

      - name: Save metrics to file
        run: |
          echo '${{ steps.metrics.outputs.result }}' > metrics/stats.json
          cat metrics/stats.json

      - name: Commit metrics (if changed)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add metrics/stats.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update metrics [skip ci]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
